@startuml Sơ Đồ Tuần Tự Nhận Dạng Biển Số

actor "Người dùng" as User
participant "Trình duyệt" as Browser
participant "Flask\nỨng dụng Web" as Flask
participant "Bộ phát hiện\nYOLO" as YOLO
participant "Tiền xử lý" as Preproc
participant "Bộ nhận dạng\nOCR" as OCR
participant "Kiểm tra\nhợp lệ" as Valid
participant "Tiện ích" as Utils

User -> Browser: Tải ảnh lên
activate Browser

Browser -> Flask: POST /api/detect-plate
activate Flask

Flask -> Flask: Kiểm tra loại file & kích thước
note right: Kiểm tra phần mở rộng\nKiểm tra kích thước < 16MB

Flask -> Flask: Lưu vào uploads/
note right: Lưu trữ tạm thời

Flask -> YOLO: detect_plates(image_path)
activate YOLO

YOLO -> YOLO: Tải mô hình YOLO
YOLO -> YOLO: Chạy suy luận (conf=0.05)
YOLO -> YOLO: Trích xuất vùng biển số (ROI)

alt YOLO thành công
    YOLO --> Flask: ROI + độ tin cậy
else YOLO thất bại
    YOLO --> Flask: None
    Flask -> Flask: Thử phương pháp OpenCV dự phòng
    note right: Phát hiện cạnh Canny\nLọc đường viền\nKiểm tra tỷ lệ khung hình
end

deactivate YOLO

Flask -> Preproc: preprocess_for_ocr(plate_image)
activate Preproc

Preproc -> Preproc: Tạo 20 biến thể
note right
  Các biến thể:
  - Gốc + Đảo ngược
  - CLAHE (clip=6.0)
  - Làm sắc nét (kernel=20)
  - Thay đổi kích thước (300-800px)
  - Hiệu chỉnh gamma
  - Khử nhiễu
end note

Preproc --> Flask: Danh sách 20 biến thể
deactivate Preproc

loop Với mỗi biến thể
    Flask -> OCR: read_text(variant)
    activate OCR
    
    OCR -> OCR: Nhận dạng EasyOCR
    note right
      Cài đặt:
      - canvas_size=5000
      - mag_ratio=3.0
      - text_threshold=0.15
      - allowlist='0-9A-Z-.'
    end note
    
    OCR -> OCR: extract_license_number()
    OCR -> OCR: fix_common_ocr_errors()
    note right: Sửa: O→0, I→1, Z→2, v.v.
    
    OCR -> OCR: smart_digit_correction()
    note right: Nhận biết ngữ cảnh: 4↔2, 5↔6, 8↔0
    
    OCR --> Flask: (text, confidence, valid)
    deactivate OCR
end

Flask -> Flask: vote_best_result(all_results)
note right
  Tính toán bỏ phiếu:
  - Đếm số phiếu
  - Điểm cơ bản (tốt nhất+trung vị+trung bình)
  - Thưởng phiếu (lên đến 30%)
  - Thưởng nhất quán (lên đến 15%)
  - Thưởng độ dài (lên đến 10%)
  - Tăng cường biển hợp lệ (tối thiểu 80%)
end note

Flask -> Valid: validate_vietnamese_plate(text)
activate Valid

Valid -> Valid: Kiểm tra mã tỉnh (01-99)
Valid -> Valid: Kiểm tra số chữ cái (1-3)
Valid -> Valid: Kiểm tra số chữ số (6-8)
Valid -> Valid: Kiểm tra định dạng

alt Biển hợp lệ
    Valid --> Flask: True
else Biển không hợp lệ
    Valid --> Flask: False
    Flask -> Flask: Từ chối kết quả
end

deactivate Valid

Flask -> Utils: format_vietnamese_plate(text)
activate Utils

Utils -> Utils: Định dạng: XX-XXXX.XX hoặc XX-X.XXXX
Utils --> Flask: Biển đã định dạng

deactivate Utils

Flask -> Flask: Dọn dẹp file tạm
note right: Xóa file đã tải lên

Flask --> Browser: Phản hồi JSON
note right
  Phản hồi:
  {
    "success": true,
    "plate_number": "52Y-6490",
    "confidence": 0.85,
    "method": "YOLO",
    "image": "base64..."
  }
end note

deactivate Flask

Browser -> Browser: Hiển thị kết quả
Browser --> User: Hiển thị biển số + độ tin cậy

deactivate Browser

@enduml
