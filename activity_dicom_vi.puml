@startuml Sơ Đồ Hoạt Động Xử Lý DICOM

start

:Người dùng tải file DICOM (.dcm);

:Flask nhận POST /api/process-dicom;

:Kiểm tra phần mở rộng file;
note right: Phải là file .dcm

if (File hợp lệ?) then (Có)
    :Lưu vào thư mục tạm;
else (Không)
    :Trả về lỗi: File không hợp lệ;
    stop
endif

partition "Đọc file DICOM" {
    :pydicom đọc file;
    
    fork
        :Phân tích header DICOM;
    fork again
        :Trích xuất dữ liệu pixel;
    fork again
        :Trích xuất siêu dữ liệu;
    end fork
}

partition "Trích xuất siêu dữ liệu" {
    :Thu thập thông tin;
    note right
      - Tên bệnh nhân
      - ID bệnh nhân
      - Ngày nghiên cứu
      - Phương thức (CT, MRI, X-Ray)
      - Kích thước ảnh
      - Window Center/Width (nếu có)
    end note
}

partition "Áp dụng Windowing mặc định" {
    if (Phương thức là gì?) then (CT)
        :Window Center=40, Width=400;
    elseif (MRI) then
        :Tự động tính toán từ khoảng pixel;
    elseif (X-Ray) then
        :Tự động tính toán;
    else (Khác)
        :Tự động tính toán;
    endif
}

partition "Chuyển đổi sang định dạng hiển thị" {
    :Áp dụng biến đổi window/level;
    note right
      Công thức:
      output = (pixel - center + width/2) / width * 255
    end note
    
    :Chuẩn hóa về khoảng 0-255;
    :Chuyển đổi sang grayscale 8-bit;
    
    if (Cần tăng cường?) then (Có)
        :Áp dụng enhancement (optional);
        note right
          - CLAHE
          - Histogram equalization
          - Gamma correction
        end note
    endif
}

partition "Mã hóa cho Web" {
    :Chuyển mảng numpy sang PIL Image;
    :Mã hóa thành JPEG;
    :Mã hóa Base64 cho hiển thị web;
}

:Trả về kết quả cho người dùng;
note right
  Kết quả:
  - Image data (base64)
  - Metadata (JSON)
  - Default window settings
end note

:Hiển thị ảnh DICOM trên trình duyệt;

partition "Điều chỉnh Window/Level (Optional)" {
    repeat
        :Người dùng điều chỉnh thanh trượt;
        
        :POST /api/adjust-window;
        note right
          Yêu cầu:
          - image_data (base64)
          - window_center (mới)
          - window_width (mới)
        end note
        
        :Nhận giá trị window center/width mới;
        
        :Tính toán lại hiển thị;
        note right
          Áp dụng công thức windowing
          với giá trị mới
        end note
        
        :Mã hóa thành base64;
        
        :Trả về ảnh đã cập nhật;
        
        :Cập nhật hiển thị trên trình duyệt;
        
    repeat while (Người dùng điều chỉnh tiếp?) is (Có)
    ->Không;
}

:Dọn dẹp file tạm;
note right: Xóa file DICOM đã tải lên

stop

@enduml
