@startuml Sơ Đồ Hoạt Động Nhận Dạng Biển Số

start

:Người dùng tải ảnh lên qua Web;

:Flask nhận POST /api/detect-plate;

:Kiểm tra loại file & kích thước;
note right
  - Kiểm tra phần mở rộng
  - Kiểm tra kích thước < 16MB
end note

:Lưu vào thư mục tạm (uploads/);

partition "Phát hiện biển số" {
    :Thử phương pháp 1: YOLO Detection;
    
    :Tải mô hình YOLO (best.pt);
    :Chạy suy luận với conf=0.05;
    :Trích xuất vùng biển số (ROI);
    
    if (YOLO thành công?) then (Có)
        :Lấy ROI từ YOLO;
    else (Không)
        :Thử phương pháp 2: OpenCV Fallback;
        
        :Chuyển đổi sang grayscale;
        :Phát hiện cạnh Canny;
        :Tìm đường viền;
        :Lọc theo tỷ lệ khung hình;
        :Trích xuất vùng biển số;
        
        if (OpenCV thành công?) then (Có)
            :Lấy ROI từ OpenCV;
        else (Không)
            :Trả về lỗi: Không phát hiện được biển số;
            stop
        endif
    endif
}

partition "Tiền xử lý" {
    :Tạo 20 biến thể ảnh;
    note right
      Các biến thể:
      - Gốc + Đảo ngược
      - CLAHE (clip=6.0)
      - Làm sắc nét (kernel=20)
      - Thay đổi kích thước (300-800px)
      - Hiệu chỉnh gamma (0.7-1.5)
      - Khử nhiễu (h=10)
    end note
}

partition "Nhận dạng OCR" {
    repeat
        :Đọc text từ biến thể;
        note right: EasyOCR với canvas_size=5000
        
        :Trích xuất số biển;
        :Sửa lỗi OCR phổ biến;
        note right: O→0, I→1, Z→2, v.v.
        
        :Sửa lỗi số thông minh;
        note right: 4↔2, 5↔6, 8↔0
        
        :Thu thập kết quả;
    repeat while (Còn biến thể?) is (Có)
    ->Không;
}

partition "Bỏ phiếu kết quả" {
    :Đếm số phiếu cho mỗi text;
    
    :Tính toán độ tin cậy;
    note right
      - Điểm cơ bản (tốt nhất + trung vị + trung bình)
      - Thưởng phiếu (lên đến 30%)
      - Thưởng nhất quán (lên đến 15%)
      - Thưởng độ dài (lên đến 10%)
      - Tăng cường biển hợp lệ (tối thiểu 80%)
    end note
    
    :Chọn text tốt nhất + độ tin cậy;
}

partition "Kiểm tra & Định dạng" {
    :Kiểm tra mã tỉnh (01-99);
    :Kiểm tra số chữ cái (1-3);
    :Kiểm tra số chữ số (6-8);
    
    if (Biển hợp lệ?) then (Có)
        :Định dạng: XX-XXXX.XX hoặc XX-X.XXXX;
    else (Không)
        :Từ chối kết quả;
        :Trả về lỗi: Biển không hợp lệ;
        :Dọn dẹp file tạm;
        stop
    endif
}

:Trả về kết quả cho người dùng;
note right
  Thành công:
  - plate_number
  - confidence
  - method
  
  Thất bại:
  - error message
  - suggestions
end note

:Dọn dẹp file tạm;
note right: Xóa file đã tải lên

stop

@enduml
