@startuml Sơ Đồ Tuần Tự Nhận Dạng Biển Số

actor "Người dùng" as User
participant "Trình duyệt" as Browser
participant "Flask\nWeb App" as Flask
participant "YOLO\nDetector" as YOLO
participant "Preprocessor" as Preproc
participant "OCR\nDetector" as OCR
participant "Validator" as Valid
participant "Utils" as Utils

User -> Browser: Upload image
activate Browser

Browser -> Flask: POST /api/detect-plate
activate Flask

Flask -> Flask: Validate file type & size
note right: Check extension\nCheck size < 16MB

Flask -> Flask: Save to uploads/
note right: Temporary storage

Flask -> YOLO: detect_plates(image_path)
activate YOLO

YOLO -> YOLO: Load YOLO model
YOLO -> YOLO: Run inference (conf=0.05)
YOLO -> YOLO: Extract plate region (ROI)

alt YOLO Success
    YOLO --> Flask: ROI + confidence
else YOLO Failed
    YOLO --> Flask: None
    Flask -> Flask: Try OpenCV fallback
    note right: Canny edge detection\nContour filtering\nAspect ratio check
end

deactivate YOLO

Flask -> Preproc: preprocess_for_ocr(plate_image)
activate Preproc

Preproc -> Preproc: Create 20 variants
note right
  Variants:
  - Original + Inverted
  - CLAHE (clip=6.0)
  - Sharpen (kernel=20)
  - Resize (300-800px)
  - Gamma correction
  - Denoise
end note

Preproc --> Flask: List of 20 variants
deactivate Preproc

loop For each variant
    Flask -> OCR: read_text(variant)
    activate OCR
    
    OCR -> OCR: EasyOCR recognition
    note right
      Settings:
      - canvas_size=5000
      - mag_ratio=3.0
      - text_threshold=0.15
      - allowlist='0-9A-Z-.'
    end note
    
    OCR -> OCR: extract_license_number()
    OCR -> OCR: fix_common_ocr_errors()
    note right: Fix: O→0, I→1, Z→2, etc.
    
    OCR -> OCR: smart_digit_correction()
    note right: Context-aware: 4↔2, 5↔6, 8↔0
    
    OCR --> Flask: (text, confidence, valid)
    deactivate OCR
end

Flask -> Flask: vote_best_result(all_results)
note right
  Vote calculation:
  - Count votes
  - Base score (best+median+avg)
  - Vote bonus (up to 30%)
  - Consistency bonus (up to 15%)
  - Length bonus (up to 10%)
  - Valid plate boost (min 80%)
end note

Flask -> Valid: validate_vietnamese_plate(text)
activate Valid

Valid -> Valid: Check province code (01-99)
Valid -> Valid: Check letter count (1-3)
Valid -> Valid: Check digit count (6-8)
Valid -> Valid: Check format

alt Valid Plate
    Valid --> Flask: True
else Invalid Plate
    Valid --> Flask: False
    Flask -> Flask: Reject result
end

deactivate Valid

Flask -> Utils: format_vietnamese_plate(text)
activate Utils

Utils -> Utils: Format: XX-XXXX.XX or XX-X.XXXX
Utils --> Flask: Formatted plate

deactivate Utils

Flask -> Flask: Cleanup temp files
note right: Delete uploaded file

Flask --> Browser: JSON response
note right
  Response:
  {
    "success": true,
    "plate_number": "52Y-6490",
    "confidence": 0.85,
    "method": "YOLO",
    "image": "base64..."
  }
end note

deactivate Flask

Browser -> Browser: Display result
Browser --> User: Show plate number + confidence

deactivate Browser

@enduml
